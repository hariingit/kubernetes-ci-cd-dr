pipeline {
    agent any

    stages {
        stage('Create Namespace') {
            steps {
                sh 'kubectl create namespace dev-namespace'
            }
        }
        stage('Create Ingress') {
            steps {
                sh 'kubectl apply -f ingress.yaml -n dev-namespace'
            }
        }
        stage('Patch Ingress') {
            steps {
                sh 'kubectl patch ingress/my-app-ingress -n dev-namespace --type=merge --patch-file patch.json'
            }
        }
        stage('Verify Green') {
            steps {
                sh 'kubectl get ingress/my-app-ingress -n dev-namespace'
            }
        }
        stage('Rollback to Blue') {
            steps {
                sh 'kubectl patch ingress/my-app-ingress -n dev-namespace --type=merge --patch-file patch-blue.json'
            }
        }
    }
    post {
        failure {
            sh 'kubectl patch ingress/my-app-ingress -n dev-namespace --type=merge --patch-file patch-blue.json'
        }
    }
}
